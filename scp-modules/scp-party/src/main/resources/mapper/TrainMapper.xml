<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bjzhianjia.scp.party.mapper.TrainMapper">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.bjzhianjia.scp.party.entity.Train" id="trainMap">
        <result property="id" column="id"/>
        <result property="trainBatch" column="train_batch"/>
        <result property="trainTitle" column="train_title"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="crtTime" column="crt_time"/>
        <result property="crtUserId" column="crt_user_id"/>
        <result property="crtUserName" column="crt_user_name"/>
        <result property="updTime" column="upd_time"/>
        <result property="updUserId" column="upd_user_id"/>
        <result property="updUserName" column="upd_user_name"/>
    </resultMap>
    <!-- 获取百人优培列表 -->
    <select id="selectTrains" resultType="java.util.Map">
        SELECT
        t.id,
        t.train_title trainTitle,
        t.start_date startDate,
        t.end_date endDate,
        case when member.count is null then 0 else member.count end memberCount,
        case when activity.count is null then 0 else activity.count end activityCount
        FROM
        train t
        LEFT JOIN (
        SELECT
        count(tgm.id) count,
        tg.train_id
        FROM
        train_group tg
        INNER JOIN train_group_member tgm ON tgm.train_group_id = tg.id
        GROUP BY
        tg.train_id
        ) member ON member.train_id = t.id
        LEFT JOIN (
        SELECT
        count(ta.id) count,
        ta.train_id
        FROM
        train_activity ta
        WHERE
        ta.is_deleted = '0'
        GROUP BY
        ta.train_id
        ) activity ON activity.train_id = t.id
        WHERE
        t.is_deleted = '0'
        <!-- 开始和结束日期必须填项 -->
        <if test="startDate != '' and endDate != '' ">
            <![CDATA[AND (t.start_date <= #{endDate}AND t.end_date >= #{startDate})]]>
        </if>
        ORDER BY
        t.crt_time DESC
    </select>
    <!-- 通过优培批次获取分组和成员信息 -->
    <select id="selectTrainGroupMember" resultType="com.alibaba.fastjson.JSONObject">
      SELECT
        tg.sort_index groupIndex,
        tgm.sort_index userIndex,
        pm.id id,
        pm.`name` `name`,
        pm.work_post workPost
    FROM
        train
    LEFT JOIN train_group tg ON tg.train_id = train.id
    LEFT JOIN train_group_member tgm ON tgm.train_group_id = tg.id
    LEFT JOIN party_member pm ON pm.id = tgm.party_member_id
    WHERE
        train.id = #{trainId}
    </select>

</mapper>